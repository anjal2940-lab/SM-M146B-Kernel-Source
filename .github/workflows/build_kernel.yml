name: Build Samsung Kernel (Magisk + SusFS)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Kernel Source
      uses: actions/checkout@v4

    - name: Set up build dependencies
      run: |
        sudo apt update
        sudo apt install -y git make gcc-aarch64-linux-gnu bc libssl-dev build-essential ccache flex bison curl libelf-dev

    - name: Apply SusFS Patches (Optional)
      run: |
        git clone https://gitlab.com/simonpunk/susfs4ksu.git susfs
        # Copy core files
        cp susfs/kernel_patches/fs/susfs.c fs/
        cp susfs/kernel_patches/include/linux/susfs.h include/linux/
        # Apply the kernel-level SusFS patch for hiding root from apps
        patch -p1 < susfs/kernel_patches/50_add_susfs_in_kernel-5.15.patch || \
        patch -p1 < susfs/kernel_patches/50_add_susfs_in_kernel-5.10.patch || echo "Patching skipped"

    - name: Stub Missing Samsung Drivers
      run: |
        # Fixes "No rule to make target" errors for missing Samsung vendor files
        DIRS=("drivers/samsung/misc" "drivers/media/platform/exynos/camera/vendor/default")
        for dir in "${DIRS[@]}"; do
          mkdir -p $dir
          echo "obj-y :=" > $dir/Makefile
        done

    - name: Compile Kernel
      env:
        ARCH: arm64
        CROSS_COMPILE: aarch64-linux-gnu-
      run: |
        make mrproper
        make s5e8535-m14xnsxx_defconfig
        make -j$(nproc) -k

    - name: Upload Kernel Image
      uses: actions/upload-artifact@v4
      with:
        name: M14-Kernel-Clean
        path: arch/arm64/boot/Image

