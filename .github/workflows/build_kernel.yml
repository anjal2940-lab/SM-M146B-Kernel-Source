name: Build Clean Samsung Kernel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Kernel Source
      uses: actions/checkout@v4

    - name: Set up build dependencies
      run: |
        sudo apt update
        sudo apt install -y git make gcc-aarch64-linux-gnu bc libssl-dev build-essential ccache flex bison curl libelf-dev

    - name: Cleanup Samsung Source (The "Fixer")
      run: |
        # 1. Remove strict error checking globally
        find . -name "Makefile*" -exec sed -i 's/-Werror//g' {} +
        find . -name "Kbuild*" -exec sed -i 's/-Werror//g' {} +

        # 2. Fix the specific 'implicit-int' error in Samsung's EMS code
        if [ -f kernel/sched/ems/sysbusy.c ]; then
          sed -i 's/static cpn_next_cpu/static int cpn_next_cpu/g' kernel/sched/ems/sysbusy.c
        fi

        # 3. Create "Stub" folders for missing Samsung vendor drivers
        # This prevents the "No rule to make target" errors
        STUB_DIRS=(
          "drivers/samsung/misc"
          "drivers/media/platform/exynos/camera/vendor/default"
          "drivers/gpu/drm/samsung/panel/ezop"
        )
        for dir in "${STUB_DIRS[@]}"; do
          mkdir -p $dir
          echo "obj-y :=" > $dir/Makefile
        done

    - name: Compile the Kernel
      env:
        ARCH: arm64
        CROSS_COMPILE: aarch64-linux-gnu-
        # This tells the compiler to be quiet about sloppy Samsung code
        KCFLAGS: "-Wno-error -Wno-implicit-function-declaration -Wno-unused-variable -Wno-format-security"
      run: |
        make mrproper
        make s5e8535-m14xnsxx_defconfig
        # -k ensures we finish the build even if a tiny non-critical driver fails
        make -j$(nproc) -k

    - name: Upload Kernel Image
      uses: actions/upload-artifact@v4
      with:
        name: M14-Clean-Kernel
        path: arch/arm64/boot/Image
