name: Build and Patch Android Kernel

on:
   workflow_dispatch: 
  push:
    branches:
      - main   # Run this workflow whenever a change is pushed to the `main` branch
  pull_request:
    branches:
      - main   # Also run for pull requests targeting the `main` branch

jobs:
  build-and-patch:
    runs-on: ubuntu-latest   # Use a Linux environment for the build process

    steps:
    # Step 1: Checkout Repository
    - name: Checkout Kernel Source
      uses: actions/checkout@v3

    # Step 2: Set Up Dependencies
    - name: Set up build dependencies
      run: |
        sudo apt update
        sudo apt install -y git make gcc bc libssl-dev build-essential ccache flex bison curl ncurses-dev xz-utils

    # Step 3: Fetch KernelSU and Apply Patch
    - name: Apply KernelSU Patch
      run: |
        git clone https://github.com/KernelSU/KernelSU.git ksu
        bash ksu/ksu.sh apply   # Automatically patches your kernel source

    # Step 4: Fetch SuSFs and Apply Patch
    - name: Apply SuSFs Patch
      run: |
        git clone https://github.com/example-user/SuSFs.git susfs
        cp -r susfs/* .

    # Step 5: Compile the Kernel
    - name: Compile the kernel
      env:
        ARCH: arm64
        CROSS_COMPILE: aarch64-linux-android-
      run: |
        make mrproper      # Clean the build environment
        make defconfig     # Load the default device config
        make -j$(nproc)    # Build the kernel using all available cores

    # Step 6: Upload the Compiled Kernel
    - name: Upload Compiled Kernel
      uses: actions/upload-artifact@v3
      with:
        name: kernel-build
        path: arch/arm64/boot/
