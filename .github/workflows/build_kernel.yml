name: Build and Patch Android Kernel

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows you to run it manually from the Actions tab

jobs:
  build-and-patch:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Kernel Source
      uses: actions/checkout@v4 # Updated to v4

    - name: Set up build dependencies
      run: |
        sudo apt update
        sudo apt install -y git make gcc bc libssl-dev build-essential ccache flex bison curl ncurses-dev xz-utils libelf-dev

    - name: Apply KernelSU Patch
      run: |
        # Using the official recommended integration method
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -

    - name: Apply SuSFs Patch
      run: |
        git clone https://gitlab.com/simonpunk/susfs4ksu.git susfs
        # Basic file copy - Note: This usually requires 'git apply' for the patches
        cp susfs/kernel/fs/susfs.c fs/
        cp susfs/kernel/include/linux/susfs.h include/linux/

    - name: Compile the kernel
      env:
        ARCH: arm64
        CROSS_COMPILE: aarch64-linux-gnu- # Use gnu for better compatibility on Ubuntu
      run: |
        make mrproper
        # Using your specific M14 config
        make s5e8535-m14xnsxx_defconfig
        make -j$(nproc)

    - name: Upload Compiled Kernel
      uses: actions/upload-artifact@v4 # Updated to v4
      with:
        name: kernel-build
        path: arch/arm64/boot/Image # Removed the trailing space and focused on the Image file
