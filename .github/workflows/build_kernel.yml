name: Build and Patch Android Kernel

on:
  workflow_dispatch:

jobs:
  build-and-patch:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Kernel Source
      uses: actions/checkout@v4

    - name: Set up build dependencies
      run: |
        sudo apt update
        # Installs the missing arm64 compiler and other build tools
        sudo apt install -y git make gcc-aarch64-linux-gnu bc libssl-dev build-essential ccache flex bison curl libelf-dev

    - name: Apply KernelSU
      run: |
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -

    - name: Apply SusFS Patches
      run: |
        git clone https://gitlab.com/simonpunk/susfs4ksu.git susfs
        
        # 1. Copy files using the EXACT paths from your screenshot
        cp susfs/kernel_patches/fs/susfs.c fs/
        cp susfs/kernel_patches/include/linux/susfs.h include/linux/
        
        # 2. Copy the KernelSU SusFS patch to the KSU folder
        cp susfs/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch KernelSU/
        
        # 3. Apply the patches
        # Entering KernelSU to patch it for SusFS support
        cd KernelSU && patch -p1 < 10_enable_susfs_for_ksu.patch && cd ..
        
        # Applying the main kernel patch (Try 5.15 first, then 5.10)
        patch -p1 < susfs/kernel_patches/50_add_susfs_in_kernel-5.15.patch || \
        patch -p1 < susfs/kernel_patches/50_add_susfs_in_kernel-5.10.patch || \
        echo "Patching failed, but continuing build..."

    - name: Bypass Missing Samsung Camera Drivers
      run: |
        # Creates the missing folder/file to stop the "No rule to make target" error
        mkdir -p drivers/media/platform/exynos/camera/vendor/default
        echo "obj-y :=" > drivers/media/platform/exynos/camera/vendor/default/Makefile

    - name: Compile the kernel
      env:
        ARCH: arm64
        CROSS_COMPILE: aarch64-linux-gnu-
      run: |
        make mrproper
        # Load your specific device config
        make s5e8535-m14xnsxx_defconfig
        # Build using all available cores
        make -j$(nproc)

    - name: Upload Compiled Kernel
      uses: actions/upload-artifact@v4
      with:
        name: M14-Kernel-SusFS
        path: arch/arm64/boot/Image
