name: Build and Patch Android Kernel

on:
  workflow_dispatch: # Allows manual trigger

jobs:
  build-and-patch:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Kernel Source
      uses: actions/checkout@v4

    - name: Set up build dependencies
      run: |
        sudo apt update
        sudo apt install -y git make bc libssl-dev build-essential ccache flex bison curl libelf-dev

    - name: Fetch AOSP Clang
      run: |
        mkdir clang
        cd clang
        wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r487747c.tar.gz
        tar -xf clang-r487747c.tar.gz
        echo "$(pwd)/bin" >> $GITHUB_PATH

    - name: Apply KernelSU
      run: |
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
        # Note: setup.sh is the modern way to integrate KernelSU into source

    - name: Apply SusFS Patch
      run: |
        git clone https://gitlab.com/simonpunk/susfs4ksu.git susfs
        # Copying files to kernel source
        cp susfs/kernel/fs/susfs.c fs/
        cp susfs/kernel/include/linux/susfs.h include/linux/
        # Note: Manual patching of kernel files (vfs, open.c, etc) is usually required for SusFS
        # If your source isn't pre-patched, this step may need specific 'git apply' commands.

    - name: Compile the kernel
      run: |
        export ARCH=arm64
        export LLVM=1
        export LLVM_IAS=1
        
        # Making the config for M14
        make O=out s5e8535-m14xnsxx_defconfig
        
        # Building the Image
        make -j$(nproc --all) O=out \
          CC=clang \
          CROSS_COMPILE=aarch64-linux-gnu- \
          CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
          LD=ld.lld \
          AR=llvm-ar \
          NM=llvm-nm \
          OBJCOPY=llvm-objcopy \
          OBJDUMP=llvm-objdump \
          STRIP=llvm-strip

    - name: Upload Compiled Kernel
      uses: actions/upload-artifact@v4
      with:
        name: M14-Kernel-KSU-SusFS
        path: out/arch/arm64/boot/Image

