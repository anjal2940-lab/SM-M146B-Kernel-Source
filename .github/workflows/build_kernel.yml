name: Build and Patch Android Kernel

on:
  workflow_dispatch:

jobs:
  build-and-patch:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Kernel Source
      uses: actions/checkout@v4

    - name: Set up build dependencies
      run: |
        sudo apt update
        sudo apt install -y git make gcc bc libssl-dev build-essential ccache flex bison curl libelf-dev

    - name: Apply KernelSU
      run: |
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -

    - name: Apply SusFS Patches
      run: |
        git clone https://gitlab.com/simonpunk/susfs4ksu.git susfs
        
        # 1. Copy the core SusFS files to your kernel source
        # Note: We use 'find' to ensure we get the right files regardless of folder depth
        cp susfs/kernel/fs/susfs.c fs/ || cp susfs/fs/susfs.c fs/
        cp susfs/kernel/include/linux/susfs.h include/linux/ || cp susfs/include/linux/susfs.h include/linux/
        
        # 2. Apply the patches to the Kernel Hooks (This is the critical step)
        # We assume your kernel is 5.x or 6.x based on the M14 hardware
        # You may need to change the patch name if your kernel version is different
        git apply susfs/kernel/patches/5.15/0001-kernel-Add-SusFS-support.patch || echo "Patch failed, checking for version 5.10"
        git apply susfs/kernel/patches/5.10/0001-kernel-Add-SusFS-support.patch || echo "Manual patching required"

    - name: Compile the kernel
      env:
        ARCH: arm64
        # Using a more standard toolchain path for Ubuntu runners
        CROSS_COMPILE: aarch64-linux-gnu-
      run: |
        make mrproper
        # Your specific Samsung M14 config
        make s5e8535-m14xnsxx_defconfig
        make -j$(nproc)

    - name: Upload Compiled Kernel
      uses: actions/upload-artifact@v4
      with:
        name: M14-Kernel-SusFS
        path: arch/arm64/boot/Image
