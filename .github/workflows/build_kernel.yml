name: Build and Patch Android Kernel

on:
  workflow_dispatch:

jobs:
  build-and-patch:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Kernel Source
      uses: actions/checkout@v4

    - name: Set up build dependencies
      run: |
        sudo apt update
        sudo apt install -y git make gcc bc libssl-dev build-essential ccache flex bison curl libelf-dev

    - name: Apply KernelSU
      run: |
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -

    - name: Apply SusFS Patches
      run: |
        git clone https://gitlab.com/simonpunk/susfs4ksu.git susfs
        
        # 1. Copy core SusFS files using the paths seen in your screenshot
        # The .c and .h files are inside kernel_patches/fs and kernel_patches/include
        cp susfs/kernel_patches/fs/susfs.c fs/
        cp susfs/kernel_patches/include/linux/susfs.h include/linux/
        
        # 2. Apply the SusFS patch to the kernel
        # For Samsung M14 (Exynos 1330), you are likely on Kernel 5.10 or 5.15
        # We try 5.15 first, then fallback to 5.10
        cd susfs/kernel_patches
        git apply 5.15/0001-kernel-Add-SusFS-support.patch || git apply 5.10/0001-kernel-Add-SusFS-support.patch || echo "Manual patch check required"
        cd ../..

    - name: Compile the kernel
      env:
        ARCH: arm64
        CROSS_COMPILE: aarch64-linux-gnu-
      run: |
        make mrproper
        make s5e8535-m14xnsxx_defconfig
        make -j$(nproc)

    - name: Upload Compiled Kernel
      uses: actions/upload-artifact@v4
      with:
        name: M14-Kernel-SusFS
        path: arch/arm64/boot/Image

